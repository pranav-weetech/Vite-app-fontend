name: Deploy → DEV (port 81)

on:
  push:
    branches:
      - dev

jobs:
  build-and-deploy:
    # run on your self-hosted runner (adjust labels if needed)
    runs-on: [self-hosted, linux, x64]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Use Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: Install frontend deps & build
        working-directory: ./frontend
        run: |
          npm ci
          npm run build

      - name: Ensure nginx.sh is executable (if exists)
        run: |
          if [ -f /home/ubuntu/nginx.sh ]; then
            sudo chmod +x /home/ubuntu/nginx.sh || true
          fi

      - name: Deploy to DEV (use /home/ubuntu/nginx.sh if present)
        run: |
          # prefer using your existing script if it's present at /home/ubuntu/nginx.sh
          if [ -f /home/ubuntu/nginx.sh ]; then
            echo "Using /home/ubuntu/nginx.sh to deploy DEV..."
            sudo /home/ubuntu/nginx.sh dev
          else
            echo "nginx.sh not found — performing inline deploy for DEV..."
            sudo rm -rf /var/www/app-dev/* || true
            sudo cp -r frontend/dist/* /var/www/app-dev/
            sudo chown -R www-data:www-data /var/www/app-dev || true
            sudo systemctl restart nginx
          fi

      - name: Post-deploy status (DEV)
        run: |
          echo "DEV deployed. Check http://75.101.222.232:81"
